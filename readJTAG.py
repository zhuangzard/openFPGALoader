#!/usr/bin/env python

# XVC FTDI JTAG Copyright (c) 2021, The Regents of the University of 
# California, through Lawrence Berkeley National Laboratory (subject to 
# receipt of any required approvals from the U.S. Dept. of Energy). All 
# rights reserved.
# 
# If you have questions about your rights to use or distribute this software,
# please contact Berkeley Lab's Intellectual Property Office at
# IPO@lbl.gov.
# 
# NOTICE.  This Software was developed under funding from the U.S. Department
# of Energy and the U.S. Government consequently retains certain rights.  As
# such, the U.S. Government has been granted for itself and others acting on
# its behalf a paid-up, nonexclusive, irrevocable, worldwide license in the
# Software to reproduce, distribute copies to the public, prepare derivative 
# works, and perform publicly and display publicly, and to permit others to
# do so.

from __future__ import print_function
import socket
import time

xvcGetinfo = bytearray(b'getinfo:')
xvcSettck = bytearray(b'settck:\x7B\x00\x00\x00')
xvcResetTap = bytearray(b'shift:\x06\x00\x00\x00\x3F\xFF')
xvcShifToID = bytearray(b'shift:\x04\x00\x00\x00\x02\xFF')
xvcGetID = bytearray(b'shift:\x20\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00')

xvcFPGA1 = bytearray(b'shift:\x2B\x00\x00\x00\x5F\x00\x00\x00\x00\x03\x00\xFE\x01\x00\x00\x00')
# xvcFPGA2 = bytearray(b'shift:\x2B\x00\x00\x00\xFF\x02\x00\x00\x00\x00\x00\xF0\x0F\x00\x00\xF0')
xvcFPGA2 = bytearray(b'shift:\x2E\x04\x00\x00\xFF\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x18\x00\xF0\x0F\x00\x00\xF0\x0F\x00\x00\xF0\x0F\x00\x00\xF0\x0F\x00\x00\xF0\x0F\x00\x00\xF0\x0F\x00\x00\xF0\x0F\x00\x00\xF0\x0F\x00\x00\xF0\x0F\x00\x00\xF0\x0F\x00\x00\xF0\x0F\x00\x00\xF0\x0F\x00\x00\xF0\x0F\x00\x00\xF0\x0F\x00\x00\xF0\x0F\x00\x00\xF0\x0F\x00\x00\xF0\x0F\x00\x00\xF0\x0F\x00\x00\xF0\x0F\x00\x00\xF0\x0F\x00\x00\xF0\x0F\x00\x00\xF0\x0F\x00\x00\xF0\x0F\x00\x00\xF0\x0F\x00\x00\xF0\x0F\x00\x00\xF0\x0F\x00\x00\xF0\x0F\x00\x00\xF0\x0F\x00\x00\xF0\x0F\x00\x00\xF0\x0F\x00\x00\xF0\x0F\x00\x00\xF0\x0F\x00\x00\xF0\x0F\x00\x00\x00')
# Tx 149:\x6B\x05\x3F\x3B\x01\x00\x6B\x04\x02\x39\x82\x00\x7F\x00\x00\x80\x7F\x00\x00\x80\xFF\xE5\x59\x

xvcFPGA3 = bytearray(b'shift:\x3A\x00\x00\x00\x37\x00\x16\x00\x00\x00\x80\x01\x00\xC2\x03\x00\x00\x00\x00\x00')
xvcFPGA4 = bytearray(b'shift:\x7D\x00\x00\x00\x37\x00\x16\x00\x00\x0B\x00\x00\x00\x00\x00\x00\x00\x00\x00\x0C\x00\xC2\x03\x00\x78\x40\x2A\x00\x00\x00\x00\x00\x00\x00\x00\x00')


sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
sock.connect(("127.0.0.1", 2542))

for cmd in (xvcGetinfo, xvcSettck, xvcResetTap, xvcShifToID):
    sock.send(cmd)
    print(sock.recv(100))

sock.send(xvcFPGA4)
id = bytearray(sock.recv(100))
print("%02X%02X%02X%02X"%(id[3], id[2], id[1], id[0]))

# sock.send(xvcFPGA1)
# id = bytearray(sock.recv(100))
# print("%02X%02X%02X%02X%02X%02X"%(id[5], id[4], id[3], id[2], id[1], id[0]))
#
# sock.send(xvcFPGA2)
# id = bytearray(sock.recv(100))
# print("%02X%02X%02X%02X%02X%02X%02X%02X%02X"%(id[8], id[7], id[6], id[5], id[4], id[3], id[2], id[1], id[0]))